<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TFY ê¸€</title>

  <!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ -->
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/post.css" />
  <link rel="stylesheet" href="assets/css/post-fix.css" />
</head>
<body>
  <!-- TOPBAR (ê¸°ì¡´ ìœ ì§€) -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" onclick="location.href='index.html'" style="cursor:pointer;">
        <span class="logo">TFY</span>
        <span class="brand-name">TFY</span>
      </div>
      <nav class="nav">
        <a class="nav-link" href="index.html">í™ˆ</a>
      </nav>
    </div>
  </div>

  <main class="page">
    <div class="grid">
      <!-- LEFT: Post -->
      <section class="left">
        <article class="card tfx-post-shell">
          <h1 id="postTitle" class="tfx-post-title">ê¸€ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</h1>
          <div id="postMeta" class="tfx-post-meta">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>

          <!-- âœ… JSê°€ ì—¬ê¸°ë¡œ â€œë³¸ë¬¸(article)â€ë§Œ ê½‚ìŠµë‹ˆë‹¤ -->
          <div id="postContent" class="tfx-post-content">
            <div style="font-weight:900; font-size:16px; margin-bottom:6px;">ê¸€ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
            <div style="color:#6B7280;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
          </div>
        </article>
      </section>

      <!-- RIGHT: Sidebar -->
      <aside class="right">
        <div id="rightSlot">
          <!-- ê¸°ë³¸ placeholder (ì´ë™ ì‹¤íŒ¨/ì¿ í° ì—†ìŒì¼ ë•Œë§Œ) -->
          <div class="card coupon-panel">
            <div class="coupon-head">
              <div class="coupon-title">ğŸ”¥ ì¿ í° ì½”ë“œ Â· ë§í¬</div>
              <div class="coupon-desc">í´ë¦­ â†’ ì½”ë“œë³µì‚¬ â†’ ì´ë™/ë‹¤ìš´ë¡œë“œ ìˆœì„œ</div>
            </div>
            <div style="color:#6B7280; font-size:13px;">í‘œì‹œí•  ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const slug = params.get("slug");

      const titleEl = document.getElementById("postTitle");
      const metaEl  = document.getElementById("postMeta");
      const contentEl = document.getElementById("postContent");
      const rightSlot = document.getElementById("rightSlot");

      // GitHub Pages ì„œë¸Œí´ë”(/repo/) ë°°í¬ ê²½ë¡œ ëŒ€ì‘
      const basePath = location.pathname.replace(/[^/]*$/, "");

      function parseHtmlToDoc(htmlText) {
        const parser = new DOMParser();
        return parser.parseFromString(htmlText, "text/html");
      }

      function removeBadWrappers(node) {
        // í˜¹ì‹œ ê¸€ íŒŒì¼ì´ í†µì§¸ë¡œ ë“¤ì–´ì˜¤ë©´ì„œ ê°™ì´ ë“¤ì–´ì˜¤ëŠ” í—¤ë”/íƒ‘ë°”ê°€ ìˆìœ¼ë©´ ì œê±°(ì¤‘ë³µ ë°©ì§€)
        if (!node) return;
        node.querySelectorAll(".topbar, .topbar-inner, header, nav").forEach(el => {
          // ê¸€ ë³¸ë¬¸ì— ë“¤ì–´ìˆëŠ” â€œì‚¬ì´íŠ¸ ì „ì²´ í—¤ë”/ë„¤ë¹„â€ ì„±ê²©ë§Œ ì œê±°
          // (ë³¸ë¬¸ ì•ˆì˜ ì¼ë°˜ì ì¸ h2/h3ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
          const cls = (el.className || "").toString();
          if (cls.includes("topbar") || el.tagName.toLowerCase() === "header" || el.tagName.toLowerCase() === "nav") {
            el.remove();
          }
        });
      }

      function extractBestArticle(doc) {
        // âœ… í•µì‹¬: posts/*.htmlì´ â€œì „ì²´ ë¬¸ì„œâ€ì—¬ë„
        // í˜ì´ì§€ ë ˆì´ì•„ì›ƒ(main/grid/sidebars)ì„ ë„£ì§€ ì•Šê³ ,
        // ë³¸ë¬¸(article)ë§Œ ë½‘ì•„ì„œ post.htmlì˜ ê¸€ ìƒìì— ê½‚ëŠ”ë‹¤.

        // 1) ê¸€ íŒŒì¼ì—ì„œ ì‹¤ì œ ë³¸ë¬¸ìœ¼ë¡œ ì“°ëŠ” article(í”„ë¡œì íŠ¸ì—ì„œ ë§ì´ ì“°ëŠ” í´ë˜ìŠ¤)
        let article =
          doc.querySelector("article.tfx-post") ||
          doc.querySelector("article.post") ||
          doc.querySelector("article") ||
          null;

        // 2) ê·¸ë˜ë„ ì—†ìœ¼ë©´ main ì•ˆì˜ ë³¸ë¬¸ ì˜ì—­ì„ ëŒ€ì²´ë¡œ ì¡ì•„ì˜´
        if (!article) {
          const main = doc.querySelector("main");
          if (main) {
            // main ì•ˆì—ì„œ ê°€ì¥ í° ì»¨í…ì¸  ë¸”ë¡ì„ ì¡ê¸°(ì•ˆì „í•˜ê²Œ)
            article = main.querySelector("article") || main;
          } else {
            article = doc.body || null;
          }
        }

        const imported = document.importNode(article, true);

        // (ì¤‘ë³µ ë°©ì§€ìš©) ë³¸ë¬¸ ì¡°ê° ì•ˆì— ì „ì²´ í˜ì´ì§€ UIê°€ ì„ì—¬ ìˆìœ¼ë©´ ì œê±°
        removeBadWrappers(imported);

        return imported;
      }

      function moveCouponAreaFromDocToSidebar(doc) {
        // âœ… posts/*.html ì•ˆì— ìˆë˜ ìš°ì¸¡ ì¿ í° ì˜ì—­ì„ rightSlotìœ¼ë¡œ ì´ë™
        // (ìš°ì¸¡ íŒ¨ë„ ì •ìƒí™”)
        // ìš°ì„ ìˆœìœ„: .coupon-panel -> .tfx-sidebar -> .tfx-side-card

        const candidates = [
          doc.querySelector(".coupon-panel"),
          doc.querySelector(".tfx-sidebar"),
          doc.querySelector(".tfx-side-card")
        ].filter(Boolean);

        if (!candidates.length) return false;

        const node = candidates[0];
        const imported = document.importNode(node, true);

        rightSlot.innerHTML = "";
        rightSlot.appendChild(imported);

        return true;
      }

      // (ì„ íƒ) ê¸€ ë³¸ë¬¸ì— ì¿ í° íŒ¨ë„ì´ ì„ì—¬ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ì œê±°(ì¤‘ë³µ/ë ˆì´ì•„ì›ƒ ê¼¬ì„ ì˜ˆë°©)
      function stripCouponFromArticle(articleNode) {
        if (!articleNode) return;
        articleNode.querySelectorAll(".coupon-panel, .tfx-sidebar, .tfx-side-card").forEach(el => el.remove());
      }

      try {
        if (!slug) {
          titleEl.textContent = "ì˜ëª»ëœ ì ‘ê·¼";
          metaEl.textContent = "slug íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          contentEl.innerHTML = `<div style="color:#E11D48;">URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
          return;
        }

        // posts.json ë¡œë“œ
        const postsRes = await fetch(`${basePath}data/posts.json`, { cache: "no-store" });
        if (!postsRes.ok) throw new Error("posts.json fetch failed");

        const postsJson = await postsRes.json();
        const items = Array.isArray(postsJson.items) ? postsJson.items : [];
        const item = items.find((x) => x.slug === slug);

        if (!item) {
          titleEl.textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
          metaEl.textContent = `slug: ${slug}`;
          contentEl.innerHTML = `<div style="color:#E11D48;">posts.jsonì— í•´ë‹¹ slugê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          return;
        }

        titleEl.textContent = item.title || "(ì œëª© ì—†ìŒ)";
        metaEl.textContent = `${item.date || ""}${item.hasCoupon ? " Â· ì¿ í° í¬í•¨" : ""} Â· ${item.category || ""}`;

        // posts/<slug>.html ë¡œë“œ
        const htmlRes = await fetch(`${basePath}posts/${slug}.html`, { cache: "no-store" });
        if (!htmlRes.ok) throw new Error(`post html fetch failed: ${htmlRes.status}`);

        const htmlText = await htmlRes.text();
        const doc = parseHtmlToDoc(htmlText);

        // 1) ìš°ì¸¡ ì¿ í° ì˜ì—­ ì´ë™(ìˆìœ¼ë©´)
        moveCouponAreaFromDocToSidebar(doc);

        // 2) ë³¸ë¬¸(article)ë§Œ ì¶”ì¶œí•´ì„œ ë„£ê¸° (âœ… ë ˆì´ì•„ì›ƒ ì¤‘ì²© ì œê±°)
        const articleNode = extractBestArticle(doc);

        // 3) ë³¸ë¬¸ ì•ˆì— ì¿ í°/ì‚¬ì´ë“œë°”ê°€ ì„ì—¬ìˆìœ¼ë©´ ì œê±°(ìš°ì¸¡ìœ¼ë¡œ ê°”ìœ¼ë‹ˆ ë³¸ë¬¸ì—ì„œëŠ” ì œê±°)
        stripCouponFromArticle(articleNode);

        contentEl.innerHTML = "";
        contentEl.appendChild(articleNode);

      } catch (err) {
        titleEl.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";
        metaEl.textContent = "ì½˜ì†”(Console)ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
        contentEl.innerHTML = `<div style="color:#E11D48;">${String(err.message || err)}</div>`;
      }
    })();
  </script>
</body>
</html>
