<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TFY ê¸€</title>

  <!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ -->
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/post.css" />
  <link rel="stylesheet" href="assets/css/post-fix.css" />
</head>
<body>
  <!-- TOPBAR (ê¸°ì¡´ ìœ ì§€) -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" onclick="location.href='index.html'" style="cursor:pointer;">
        <span class="logo">TFY</span>
        <span class="brand-name">TFY</span>
      </div>
      <nav class="nav">
        <a class="nav-link" href="index.html">í™ˆ</a>
      </nav>
    </div>
  </div>

  <main class="page">
    <div class="grid">
      <!-- LEFT: Post -->
      <section class="left">
        <article class="card tfx-post-shell">
          <h1 id="postTitle" class="tfx-post-title">ê¸€ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</h1>
          <div id="postMeta" class="tfx-post-meta">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>

          <!-- âœ… JSê°€ ì—¬ê¸°ë¡œ ê¸€ ë‚´ìš©ì„ ê½‚ìŠµë‹ˆë‹¤ -->
          <div id="postContent" class="tfx-post-content">
            <div style="font-weight:900; font-size:16px; margin-bottom:6px;">ê¸€ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
            <div style="color:#6B7280;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
          </div>
        </article>
      </section>

      <!-- RIGHT: Sidebar -->
      <aside class="right">
        <div id="rightSlot">
          <!-- ê¸°ë³¸ placeholder (ì´ë™ ì‹¤íŒ¨/ì¿ í° ì—†ìŒì¼ ë•Œë§Œ) -->
          <div class="card coupon-panel">
            <div class="coupon-head">
              <div class="coupon-title">ğŸ”¥ ì¿ í° ì½”ë“œ Â· ë§í¬</div>
              <div class="coupon-desc">í´ë¦­ â†’ ì½”ë“œë³µì‚¬ â†’ ì´ë™ ìˆœì„œë¡œ ì§„í–‰í•˜ì„¸ìš”.</div>
            </div>
            <div style="color:#6B7280; font-size:13px;">í‘œì‹œí•  ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const slug = params.get("slug");

      const titleEl = document.getElementById("postTitle");
      const metaEl  = document.getElementById("postMeta");
      const contentEl = document.getElementById("postContent");
      const rightSlot = document.getElementById("rightSlot");

      // GitHub Pages ì„œë¸Œí´ë” ëŒ€ì‘ìš© basePath
      const basePath = location.pathname.replace(/[^/]*$/, "");

      function importMainOnly(htmlText){
        // âœ… í•µì‹¬: posts/*.htmlì´ "ì „ì²´ ë¬¸ì„œ(doctype/html/body)"ì—¬ë„
        // <main class="tfx-post-shell">ë§Œ ë½‘ì•„ì„œ ë³¸ë¬¸ì— ë„£ìœ¼ë©´ ê¸€ ìƒìê°€ ì •ìƒìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");

        // 1ìˆœìœ„: ê¸€ ë³¸ë¬¸ìš© main
        let main = doc.querySelector("main.tfx-post-shell");
        if (main) return document.importNode(main, true);

        // 2ìˆœìœ„: body ì „ì²´ (ê·¸ë˜ë„ full ë¬¸ì„œê°€ ì˜¤ë©´ bodyë§Œì´ë¼ë„)
        if (doc.body) return document.importNode(doc.body, true);

        // ìµœí›„: ê·¸ëƒ¥ ë¬¸ìì—´
        const wrap = document.createElement("div");
        wrap.innerHTML = htmlText;
        return wrap;
      }

      function moveEmbeddedCouponPanelToSidebar(){
        if (!contentEl || !rightSlot) return false;

        // 1) ì˜ˆì „ êµ¬ì¡°: .coupon-panel
        const legacy = contentEl.querySelector(".coupon-panel");
        if (legacy) {
          legacy.remove();
          rightSlot.innerHTML = "";
          rightSlot.appendChild(legacy);
          return true;
        }

        // 2) í˜„ì¬ ê¸€ íŒŒì¼ êµ¬ì¡°: aside.tfx-sidebar
        const tfxSidebar = contentEl.querySelector(".tfx-sidebar");
        if (tfxSidebar) {
          tfxSidebar.remove();
          rightSlot.innerHTML = "";
          rightSlot.appendChild(tfxSidebar);
          return true;
        }

        // 3) ì¹´ë“œë§Œ ìˆëŠ” ê²½ìš°
        const tfxSideCard = contentEl.querySelector(".tfx-side-card");
        if (tfxSideCard) {
          tfxSideCard.remove();
          rightSlot.innerHTML = "";
          rightSlot.appendChild(tfxSideCard);
          return true;
        }

        return false;
      }

      // (ì„ íƒ) í˜¹ì‹œ main ë‚´ë¶€ì— ë‚¨ì•„ìˆë˜ í—¤ë”ê°€ ìˆìœ¼ë©´ ì œê±°(ì¤‘ë³µ ë°©ì§€ìš©)
      function removeEmbeddedHeaderIfAny(){
        const embeddedHeader = contentEl.querySelector(".tfx-topbar, header.tfx-topbar");
        if (embeddedHeader) embeddedHeader.remove();
      }

      try {
        if (!slug) {
          titleEl.textContent = "ì˜ëª»ëœ ì ‘ê·¼";
          metaEl.textContent = "slug íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          contentEl.innerHTML = `<div style="color:#E11D48;">URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
          return;
        }

        const postsRes = await fetch(`${basePath}data/posts.json`, { cache: "no-store" });
        if (!postsRes.ok) throw new Error("posts.json fetch failed");
        const postsJson = await postsRes.json();
        const items = Array.isArray(postsJson.items) ? postsJson.items : [];
        const item = items.find((x) => x.slug === slug);

        if (!item) {
          titleEl.textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
          metaEl.textContent = `slug: ${slug}`;
          contentEl.innerHTML = `<div style="color:#E11D48;">posts.jsonì— í•´ë‹¹ slugê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          return;
        }

        titleEl.textContent = item.title || "(ì œëª© ì—†ìŒ)";
        metaEl.textContent = `${item.date || ""}${item.hasCoupon ? " Â· ì¿ í° í¬í•¨" : ""} Â· ${item.category || ""}`;

        // posts/<slug>.html ë¡œë“œ
        const htmlRes = await fetch(`${basePath}posts/${slug}.html`, { cache: "no-store" });
        if (!htmlRes.ok) throw new Error(`post html fetch failed: ${htmlRes.status}`);

        const htmlText = await htmlRes.text();

        // âœ… ê¸€ ìƒì ì •ìƒí™”: ì „ì²´ ë¬¸ì„œê°€ ì™€ë„ mainë§Œ ì¶”ì¶œí•´ì„œ ì‚½ì…
        const mainNode = importMainOnly(htmlText);
        contentEl.innerHTML = "";
        contentEl.appendChild(mainNode);

        // ì¤‘ë³µ header ì œê±°(ìˆìœ¼ë©´ë§Œ)
        removeEmbeddedHeaderIfAny();

        // âœ… ìš°ì¸¡ ì¿ í°/ì‚¬ì´ë“œë°” ì´ë™
        moveEmbeddedCouponPanelToSidebar();

      } catch (err) {
        titleEl.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";
        metaEl.textContent = "ì½˜ì†”(Console)ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
        contentEl.innerHTML = `<div style="color:#E11D48;">${String(err.message || err)}</div>`;
      }
    })();
  </script>
</body>
</html>
