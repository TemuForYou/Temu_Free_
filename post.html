<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TFY ê¸€</title>

  <!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ -->
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/post.css" />
</head>
<body>
  <!-- TOPBAR (ê¸°ì¡´ ìœ ì§€) -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" onclick="location.href='index.html'" style="cursor:pointer;">
        <span class="logo">TFY</span>
        <span class="brand-name">TFY</span>
      </div>
      <nav class="nav">
        <a class="nav-link" href="index.html">í™ˆ</a>
      </nav>
    </div>
  </div>

  <main class="page">
    <div class="grid">
      <!-- LEFT: Post -->
      <section class="left">
        <article class="card tfx-post-shell">
          <h1 id="postTitle" class="tfx-post-title">ê¸€ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</h1>
          <div id="postMeta" class="tfx-post-meta">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>

          <!-- âœ… JSê°€ ì—¬ê¸°ë¡œ ë‚´ìš©ì„ ê½‚ìŠµë‹ˆë‹¤ -->
          <div id="postContent" class="tfx-post-content">
            <div style="font-weight:900; font-size:16px; margin-bottom:6px;">ê¸€ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
            <div style="color:#6B7280;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
          </div>
        </article>
      </section>

      <!-- RIGHT: Coupons (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€ + JSë¡œ ì±„ì›€) -->
      <aside class="right">
        <div class="card coupon-panel">
          <div class="coupon-head">
            <div class="coupon-title">ğŸ”¥ ì¿ í° ì½”ë“œ Â· ë§í¬</div>
            <div class="coupon-desc">í´ë¦­ â†’ ì½”ë“œë³µì‚¬ â†’ ì´ë™ ìˆœì„œë¡œ ì§„í–‰í•˜ì„¸ìš”.</div>
          </div>

          <!-- âœ… JSê°€ ì—¬ê¸°ë¡œ ì¿ í° ëª©ë¡ì„ ê½‚ìŠµë‹ˆë‹¤ -->
          <div class="coupon-list" id="postCoupons"></div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const slug = params.get("slug");

      const titleEl = document.getElementById("postTitle");
      const metaEl  = document.getElementById("postMeta");
      const contentEl = document.getElementById("postContent");

      // Base path for GitHub Pages subdir deployments (e.g. /Temu_Free_/)
      const basePath = location.pathname.replace(/[^/]*$/, "");

      const renderCoupons = async () => {
        const host = document.getElementById("postCoupons");
        if (!host) return;

        try {
          const r = await fetch(`${basePath}data/coupons.json`, { cache: "no-store" });
          if (!r.ok) throw new Error("coupons.json fetch failed");
          const json = await r.json();
          const items = Array.isArray(json.items) ? json.items : [];

          if (!items.length) {
            host.innerHTML = `<div style="color:#6B7280; font-size:13px;">í‘œì‹œí•  ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
          }

          host.innerHTML = items.map((c) => {
            const safeCode = String(c.code || "").replace(/[<>"']/g, "");
            const link = String(c.link || "#").replace(/"/g, "&quot;");
            const label = String(c.label || "").replace(/[<>"']/g, "");

            return `
              <div class="coupon-row">
                <div class="coupon-chip">
                  <div class="coupon-badge">${label}</div>
                  <div class="coupon-code">CODE <b>${safeCode}</b></div>
                </div>
                <button class="btn btn-light" data-copy="${safeCode}">ë³µì‚¬</button>
                <a class="btn btn-primary" href="${link}" target="_blank" rel="noopener">ì´ë™</a>

                <!-- âœ… ìš”ì²­í•˜ì‹ : ì½”ë“œ/ë³µì‚¬/ì´ë™ ì•„ë˜ì— ê¸¸ê²Œ 'ë‹¤ìš´ë¡œë“œ' ë²„íŠ¼ -->
                <a class="btn btn-primary"
                   style="width:100%; margin-top:10px; justify-content:center;"
                   href="${link}" target="_blank" rel="noopener">
                  ë‹¤ìš´ë¡œë“œ
                </a>
              </div>
            `;
          }).join("");

          // copy handlers
          host.querySelectorAll("[data-copy]").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const txt = btn.getAttribute("data-copy") || "";
              try {
                await navigator.clipboard.writeText(txt);
                btn.textContent = "ë³µì‚¬ë¨";
                setTimeout(() => (btn.textContent = "ë³µì‚¬"), 900);
              } catch {
                // fallback
                const ta = document.createElement("textarea");
                ta.value = txt;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand("copy");
                ta.remove();
                btn.textContent = "ë³µì‚¬ë¨";
                setTimeout(() => (btn.textContent = "ë³µì‚¬"), 900);
              }
            });
          });
        } catch (e) {
          host.innerHTML = `<div style="color:#E11D48; font-size:13px;">ì¿ í° ë¡œë”© ì‹¤íŒ¨: ${String(e.message || e)}</div>`;
        }
      };

      try {
        if (!slug) {
          if (titleEl) titleEl.textContent = "ì˜ëª»ëœ ì ‘ê·¼";
          if (metaEl) metaEl.textContent = "slug íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          if (contentEl) contentEl.innerHTML = `<div style="color:#E11D48;">URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
          await renderCoupons();
          return;
        }

        const postsRes = await fetch(`${basePath}data/posts.json`, { cache: "no-store" });
        if (!postsRes.ok) throw new Error("posts.json fetch failed");
        const postsJson = await postsRes.json();
        const items = Array.isArray(postsJson.items) ? postsJson.items : [];
        const item = items.find((x) => x.slug === slug);

        if (!item) {
          if (titleEl) titleEl.textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
          if (metaEl) metaEl.textContent = `slug: ${slug}`;
          if (contentEl) contentEl.innerHTML = `<div style="color:#E11D48;">posts.jsonì— í•´ë‹¹ slugê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          await renderCoupons();
          return;
        }

        if (titleEl) titleEl.textContent = item.title || "(ì œëª© ì—†ìŒ)";
        if (metaEl) metaEl.textContent = `${item.date || ""}${item.hasCoupon ? " Â· ì¿ í° í¬í•¨" : ""} Â· ${item.category || ""}`;

        // posts/<slug>.html ë¡œë“œ
        const htmlRes = await fetch(`${basePath}posts/${slug}.html`, { cache: "no-store" });
        if (!htmlRes.ok) throw new Error(`post html fetch failed: ${htmlRes.status}`);

        const html = await htmlRes.text();
        if (contentEl) contentEl.innerHTML = html;

        await renderCoupons();
      } catch (err) {
        if (titleEl) titleEl.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";
        if (metaEl) metaEl.textContent = "ì½˜ì†”(Console)ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
        if (contentEl) contentEl.innerHTML = `<div style="color:#E11D48;">${String(err.message || err)}</div>`;
        await renderCoupons();
      }
    })();
  </script>
</body>
</html>
